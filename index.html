<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuckBoosChat (DBC)</title>
    <style>
        /* 保持原有的CSS样式不变 */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            background-color: #f5f5f5;
        }
        
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .user-info {
            padding: 10px;
            background-color: #34495e;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .menu-button {
            padding: 10px;
            background-color: #34495e;
            border: none;
            color: white;
            text-align: left;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .menu-button:hover {
            background-color: #3d566e;
        }
        
        .add-friend-box, .add-group-box {
            margin-top: 5px;
            padding: 10px;
            background-color: #34495e;
            border-radius: 5px;
            display: none;
        }
        
        .add-friend-box input, .add-group-box input {
            width: 100%;
            padding: 5px;
            margin-bottom: 5px;
            box-sizing: border-box;
        }
        
        .add-friend-box button, .add-group-box button {
            width: 100%;
            padding: 5px;
            background-color: #27ae60;
            border: none;
            color: white;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-header {
            padding: 15px;
            background-color: #3498db;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .show-members-btn {
            padding: 5px 10px;
            background-color: #2980b9;
            border: none;
            color: white;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .chat-members {
            display: none;
            padding: 10px;
            background-color: #ecf0f1;
            border-bottom: 1px solid #ddd;
        }
        
        .member-item {
            padding: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .kick-member {
            color: #e74c3c;
            cursor: pointer;
            font-size: 12px;
        }
        
        .chat-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: white;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            max-width: 70%;
            word-wrap: break-word;
        }
        
        .my-message {
            background-color: #2ecc71;
            color: white;
            margin-left: auto;
        }
        
        .other-message {
            background-color: #ecf0f1;
            margin-right: auto;
        }
        
        .sender-name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .message-time {
            font-size: 10px;
            text-align: right;
            margin-top: 5px;
            opacity: 0.7;
        }
        
        .input-area {
            padding: 15px;
            background-color: #ecf0f1;
            display: flex;
            gap: 10px;
        }
        
        .message-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .send-button, .upload-button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .send-button {
            background-color: #3498db;
            color: white;
        }
        
        .upload-button {
            background-color: #95a5a6;
            color: white;
        }
        
        .login-container, .register-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .login-box, .register-box {
            background-color: white;
            padding: 30px;
            border-radius: 5px;
            width: 300px;
        }
        
        .login-box h2, .register-box h2 {
            margin-top: 0;
            text-align: center;
            color: #2c3e50;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .submit-btn {
            width: 100%;
            padding: 10px;
            background-color: #3498db;
            border: none;
            color: white;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .switch-form {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .switch-form a {
            color: #3498db;
            cursor: pointer;
        }
        
        .requests-container {
            padding: 20px;
        }
        
        .request-item {
            padding: 10px;
            background-color: #ecf0f1;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .request-actions button {
            padding: 5px 10px;
            margin-left: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .accept-btn {
            background-color: #2ecc71;
            color: white;
        }
        
        .reject-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .rename-group-btn {
            background-color: #f39c12;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 5px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .friends-list, .groups-list {
            padding: 20px;
        }
        
        .friend-item, .group-item {
            padding: 10px;
            background-color: #ecf0f1;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .friend-item:hover, .group-item:hover {
            background-color: #d6eaf8;
        }
        
        .active-chat {
            background-color: #d6eaf8;
            font-weight: bold;
        }
        
        .language-switcher {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1001;
        }
        
        .language-btn {
            padding: 5px 10px;
            background-color: #3498db;
            border: none;
            color: white;
            border-radius: 3px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Language Switcher -->
    <div class="language-switcher">
        <button class="language-btn" id="switchToEnglish">English</button>
        <button class="language-btn" id="switchToChinese">中文</button>
    </div>

    <!-- Login Modal -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h2 data-i18n="login_title">登录DBC / Login to DBC</h2>
            <div class="form-group">
                <label for="loginUsername" data-i18n="username">用户名 / Username</label>
                <input type="text" id="loginUsername" placeholder="输入用户名 / Enter username">
            </div>
            <div class="form-group">
                <label for="loginPassword" data-i18n="password">密码 / Password</label>
                <input type="password" id="loginPassword" placeholder="输入密码 / Enter password">
            </div>
            <button class="submit-btn" id="loginBtn" data-i18n="login">登录 / Login</button>
            <div class="switch-form">
                <span data-i18n="no_account">没有账号? / Don't have an account?</span> <a id="showRegister" data-i18n="register">注册 / Register</a>
            </div>
        </div>
    </div>
    
    <!-- Register Modal -->
    <div class="register-container" id="registerContainer" style="display: none;">
        <div class="register-box">
            <h2 data-i18n="register_title">注册DBC账号 / Register for DBC</h2>
            <div class="form-group">
                <label for="registerName" data-i18n="name">姓名 / Name</label>
                <input type="text" id="registerName" placeholder="输入姓名 / Enter your name">
            </div>
            <div class="form-group">
                <label for="registerUsername" data-i18n="username">用户名 / Username</label>
                <input type="text" id="registerUsername" placeholder="选择用户名 / Choose username">
            </div>
            <div class="form-group">
                <label for="registerPassword" data-i18n="password">密码 / Password</label>
                <input type="password" id="registerPassword" placeholder="设置密码 / Choose password">
            </div>
            <div class="form-group">
                <label for="registerEmail" data-i18n="email">邮箱 / Email</label>
                <input type="email" id="registerEmail" placeholder="输入邮箱 / Enter email">
            </div>
            <div class="form-group">
                <label for="registerCode" data-i18n="reg_code">注册码 / Registration Code</label>
                <input type="text" id="registerCode" placeholder="输入注册码 / Enter code" value="ssxxzyzyabab">
            </div>
            <button class="submit-btn" id="registerBtn" data-i18n="register">注册 / Register</button>
            <div class="switch-form">
                <span data-i18n="have_account">已有账号? / Already have an account?</span> <a id="showLogin" data-i18n="login">登录 / Login</a>
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div class="sidebar" id="sidebar" style="display: none;">
        <div class="user-info" id="userInfo">
            <div id="userName">Loading...</div>
            <div id="userId">Loading...</div>
        </div>
        
        <div class="menu">
            <button class="menu-button" id="friendsChatBtn" data-i18n="friend_chat">好友聊天 / Friend Chat</button>
            <button class="menu-button" id="groupChatBtn" data-i18n="group_chat">多人聊天 / Group Chat</button>
            <button class="menu-button" id="addFriendBtn" data-i18n="add_friend">添加好友 / Add Friend</button>
            <div class="add-friend-box" id="addFriendBox">
                <input type="text" id="friendIdInput" placeholder="输入好友ID或用户名 / Enter friend's ID or username">
                <button id="sendFriendRequestBtn" data-i18n="send_request">发送请求 / Send Request</button>
            </div>
            <button class="menu-button" id="createGroupBtn" data-i18n="create_group">创建多人聊天 / Create Group</button>
            <button class="menu-button" id="addGroupBtn" data-i18n="join_group">加入多人聊天 / Join Group</button>
            <div class="add-group-box" id="addGroupBox">
                <input type="text" id="groupIdInput" placeholder="输入群组ID / Enter group ID (8 digits)">
                <button id="sendGroupRequestBtn" data-i18n="send_request">发送请求 / Send Request</button>
            </div>
            <button class="menu-button" id="requestsBtn" data-i18n="requests">申请 / Requests</button>
        </div>
    </div>
    
    <div class="main-content" id="mainContent" style="display: none;">
        <!-- Friends Chat View -->
        <div class="friends-list" id="friendsList" style="display: none;">
            <h2 data-i18n="friend_chat">好友聊天 / Friend Chat</h2>
            <div id="friendsContainer"></div>
        </div>
        
        <!-- Group Chat View -->
        <div class="groups-list" id="groupsList" style="display: none;">
            <h2 data-i18n="group_chat">多人聊天 / Group Chat</h2>
            <div id="groupsContainer"></div>
        </div>
        
        <!-- Chat View -->
        <div class="chat-view" id="chatView" style="display: none;">
            <div class="chat-header" id="chatHeader">
                <div id="chatTitle" data-i18n="select_chat">选择聊天 / Select a chat</div>
                <button class="show-members-btn" id="showMembersBtn" style="display: none;" data-i18n="show_members">显示成员 / Show Members</button>
            </div>
            <div class="chat-members" id="chatMembers">
                <!-- Members will be listed here -->
            </div>
            <div class="chat-area" id="chatArea">
                <!-- Messages will appear here -->
                <div style="text-align: center; color: #7f8c8d; margin-top: 50px;" data-i18n="select_chat_prompt">
                    选择聊天开始对话 / Select a chat to start messaging
                </div>
            </div>
            <div class="input-area" id="inputArea" style="display: none;">
                <input type="text" class="message-input" id="messageInput" placeholder="输入消息... / Type a message...">
                <button class="upload-button" id="uploadButton" data-i18n="upload">上传 / Upload</button>
                <button class="send-button" id="sendButton" data-i18n="send">发送 / Send</button>
            </div>
        </div>
        
        <!-- Requests View -->
        <div class="requests-container" id="requestsView" style="display: none;">
            <h2 data-i18n="requests">申请 / Requests</h2>
            <div id="requestsContainer">
                <div style="text-align: center; color: #7f8c8d; margin-top: 50px;" data-i18n="no_requests">
                    没有待处理申请 / No pending requests
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Language support
        const translations = {
            "en": {
                "login_title": "Login to DBC",
                "username": "Username",
                "password": "Password",
                "login": "Login",
                "no_account": "Don't have an account?",
                "register": "Register",
                "register_title": "Register for DBC",
                "name": "Name",
                "email": "Email",
                "reg_code": "Registration Code",
                "have_account": "Already have an account?",
                "friend_chat": "Friend Chat",
                "group_chat": "Group Chat",
                "add_friend": "Add Friend",
                "create_group": "Create Group",
                "join_group": "Join Group",
                "requests": "Requests",
                "send_request": "Send Request",
                "select_chat": "Select a chat",
                "show_members": "Show Members",
                "select_chat_prompt": "Select a chat to start messaging",
                "no_requests": "No pending requests",
                "upload": "Upload",
                "send": "Send",
                "kick_member": "Kick",
                "rename_group": "Rename"
            },
            "zh": {
                "login_title": "登录DBC",
                "username": "用户名",
                "password": "密码",
                "login": "登录",
                "no_account": "没有账号?",
                "register": "注册",
                "register_title": "注册DBC账号",
                "name": "姓名",
                "email": "邮箱",
                "reg_code": "注册码",
                "have_account": "已有账号?",
                "friend_chat": "好友聊天",
                "group_chat": "多人聊天",
                "add_friend": "添加好友",
                "create_group": "创建多人聊天",
                "join_group": "加入多人聊天",
                "requests": "申请",
                "send_request": "发送请求",
                "select_chat": "选择聊天",
                "show_members": "显示成员",
                "select_chat_prompt": "选择聊天开始对话",
                "no_requests": "没有待处理申请",
                "upload": "上传",
                "send": "发送",
                "kick_member": "提出",
                "rename_group": "修改名字"
            }
        };

        let currentLanguage = "zh"; // Default to Chinese

        function switchLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll("[data-i18n]").forEach(element => {
                const key = element.getAttribute("data-i18n");
                if (translations[lang][key]) {
                    if (element.tagName === "INPUT" && element.hasAttribute("placeholder")) {
                        element.placeholder = translations[lang][key];
                    } else {
                        element.textContent = translations[lang][key];
                    }
                }
            });
        }

        // Database simulation with file storage
        let users = [];
        let currentUser = null;
        let friends = {};
        let groups = {};
        let messages = {};
        let friendRequests = {};
        let groupRequests = {};
        let nextUserId = 1;
        
        // Helper functions for file operations
        async function loadDataFromFile(path) {
            try {
                const response = await fetch(path);
                if (!response.ok) return null;
                return await response.json();
            } catch (e) {
                console.error("Error loading data:", e);
                return null;
            }
        }
        
        async function saveDataToFile(path, data) {
            try {
                const response = await fetch(path, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                return response.ok;
            } catch (e) {
                console.error("Error saving data:", e);
                return false;
            }
        }
        
        // Initialize data from server
        async function initializeData() {
            // Load users
            const loadedUsers = await loadDataFromFile('/users/users.json');
            if (loadedUsers) {
                users = loadedUsers;
                // Find the highest user ID to set nextUserId
                const maxId = users.reduce((max, user) => {
                    const num = parseInt(user.id.replace('CNDBC', ''));
                    return num > max ? num : max;
                }, 0);
                nextUserId = maxId + 1;
            }
            
            // Load current user if logged in
            const savedUser = localStorage.getItem('dbc_currentUser');
            if (savedUser) {
                const user = JSON.parse(savedUser);
                const foundUser = findUserByUsername(user.username);
                if (foundUser && foundUser.password === user.password) {
                    await loginUser(foundUser);
                } else {
                    localStorage.removeItem('dbc_currentUser');
                }
            }
        }
        
        // Find user by ID
        function findUserById(userId) {
            return users.find(user => user.id === userId);
        }
        
        // Find user by username
        function findUserByUsername(username) {
            return users.find(user => user.username === username);
        }
        
        // Get friend chat ID
        function getFriendChatId(userId1, userId2) {
            const sortedIds = [userId1, userId2].sort();
            return `friend_${sortedIds[0]}_${sortedIds[1]}`;
        }
        
        // Get group chat ID
        function getGroupChatId(groupId) {
            return `group_${groupId}`;
        }
        
        // Show login form
        function showLogin() {
            document.getElementById('loginContainer').style.display = "flex";
            document.getElementById('registerContainer').style.display = "none";
        }
        
        // Show register form
        function showRegisterForm() {
            document.getElementById('loginContainer').style.display = "none";
            document.getElementById('registerContainer').style.display = "flex";
        }
        
        // Login user
        async function loginUser(user) {
            currentUser = user;
            localStorage.setItem('dbc_currentUser', JSON.stringify(user));
            
            // Load user-specific data
            const userId = user.id;
            
            // Load friends
            const loadedFriends = await loadDataFromFile(`/friends/${userId}.json`);
            if (loadedFriends) {
                friends[userId] = loadedFriends;
            } else {
                friends[userId] = [];
                await saveDataToFile(`/friends/${userId}.json`, []);
            }
            
            // Load friend requests
            const loadedFriendRequests = await loadDataFromFile(`/friend_requests/${userId}.json`);
            if (loadedFriendRequests) {
                friendRequests[userId] = loadedFriendRequests;
            } else {
                friendRequests[userId] = [];
                await saveDataToFile(`/friend_requests/${userId}.json`, []);
            }
            
            // Load group requests
            const loadedGroupRequests = await loadDataFromFile(`/group_requests/${userId}.json`);
            if (loadedGroupRequests) {
                groupRequests[userId] = loadedGroupRequests;
            } else {
                groupRequests[userId] = [];
                await saveDataToFile(`/group_requests/${userId}.json`, []);
            }
            
            // Load groups (need to load all and filter)
            const allGroups = await loadDataFromFile('/groups/all_groups.json') || [];
            groups = {};
            allGroups.forEach(group => {
                if (group.members.includes(userId)) {
                    groups[group.id] = group;
                }
            });
            
            // Update UI
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userId').textContent = user.id;
            
            // Show main app
            document.getElementById('loginContainer').style.display = "none";
            document.getElementById('registerContainer').style.display = "none";
            document.getElementById('sidebar').style.display = "flex";
            document.getElementById('mainContent').style.display = "flex";
            
            // Load user data
            loadUserData();
            
            return true;
        }
        
        // Login with credentials
        async function login(username, password) {
            const user = findUserByUsername(username);
            
            if (user && user.password === password) {
                return await loginUser(user);
            }
            
            return false;
        }
        
        // Register new user
        async function register(name, username, password, email, code) {
            if (code.toLowerCase() !== "ssxxzyzyabab") {
                alert(currentLanguage === "zh" ? "注册码不正确" : "Invalid registration code");
                return false;
            }
            
            if (findUserByUsername(username)) {
                alert(currentLanguage === "zh" ? "用户名已存在" : "Username already exists");
                return false;
            }
            
            const newUser = {
                id: `CNDBC${nextUserId++}`,
                name,
                username,
                password,
                email
            };
            
            users.push(newUser);
            
            // Save users list
            await saveDataToFile('/users/users.json', users);
            
            // Create user data files
            await saveDataToFile(`/friends/${newUser.id}.json`, []);
            await saveDataToFile(`/friend_requests/${newUser.id}.json`, []);
            await saveDataToFile(`/group_requests/${newUser.id}.json`, []);
            
            // Create messages directory for user
            // This would be handled by the server in a real implementation
            
            // Auto-login the new user
            const success = await loginUser(newUser);
            if (success) {
                alert(currentLanguage === "zh" ? "注册成功！您已登录。" : "Registration successful! You are now logged in.");
                document.getElementById('registerContainer').style.display = "none";
            }
            return success;
        }
        
        // Load user data
        async function loadUserData() {
            if (!currentUser) return;
            
            // Show friends list by default
            showFriendsList();
            
            // Check if user has any friends
            if (friends[currentUser.id] && friends[currentUser.id].length > 0) {
                renderFriendsList();
            } else {
                document.getElementById('friendsContainer').innerHTML = `
                    <div style="text-align: center; color: #7f8c8d; margin-top: 50px;">
                        ${currentLanguage === "zh" ? "您还没有好友，添加好友开始聊天吧！" : "You don't have any friends yet. Add some friends to start chatting!"}
                    </div>
                `;
            }
            
            // Check if user has any groups
            const userGroups = Object.values(groups).filter(group => 
                group.members.includes(currentUser.id)
            );
            
            if (userGroups.length > 0) {
                renderGroupsList();
            }
            
            // Check if user has any pending requests
            const hasFriendRequests = friendRequests[currentUser.id] && friendRequests[currentUser.id].length > 0;
            const hasGroupRequests = groupRequests[currentUser.id] && groupRequests[currentUser.id].length > 0;
            
            if (hasFriendRequests || hasGroupRequests) {
                renderRequests();
            }
        }
        
        // Show friends list view
        function showFriendsList() {
            document.getElementById('friendsList').style.display = "block";
            document.getElementById('groupsList').style.display = "none";
            document.getElementById('chatView').style.display = "none";
            document.getElementById('requestsView').style.display = "none";
            
            // Reset active buttons
            document.querySelectorAll('.menu-button').forEach(btn => {
                btn.style.backgroundColor = '#34495e';
            });
            document.getElementById('friendsChatBtn').style.backgroundColor = '#3d566e';
        }
        
        // Show groups list view
        function showGroupsList() {
            document.getElementById('friendsList').style.display = "none";
            document.getElementById('groupsList').style.display = "block";
            document.getElementById('chatView').style.display = "none";
            document.getElementById('requestsView').style.display = "none";
            
            // Reset active buttons
            document.querySelectorAll('.menu-button').forEach(btn => {
                btn.style.backgroundColor = '#34495e';
            });
            document.getElementById('groupChatBtn').style.backgroundColor = '#3d566e';
        }
        
        // Show chat view
        function showChatView() {
            document.getElementById('friendsList').style.display = "none";
            document.getElementById('groupsList').style.display = "none";
            document.getElementById('chatView').style.display = "flex";
            document.getElementById('requestsView').style.display = "none";
            
            // Reset active buttons
            document.querySelectorAll('.menu-button').forEach(btn => {
                btn.style.backgroundColor = '#34495e';
            });
        }
        
        // Show requests view
        function showRequestsView() {
            document.getElementById('friendsList').style.display = "none";
            document.getElementById('groupsList').style.display = "none";
            document.getElementById('chatView').style.display = "none";
            document.getElementById('requestsView').style.display = "block";
            
            // Reset active buttons
            document.querySelectorAll('.menu-button').forEach(btn => {
                btn.style.backgroundColor = '#34495e';
            });
            document.getElementById('requestsBtn').style.backgroundColor = '#3d566e';
            
            renderRequests();
        }
        
        // Render friends list
        function renderFriendsList() {
            if (!currentUser || !friends[currentUser.id]) return;
            
            document.getElementById('friendsContainer').innerHTML = '';
            
            friends[currentUser.id].forEach(friendId => {
                const friend = findUserById(friendId);
                if (!friend) return;
                
                const friendElement = document.createElement('div');
                friendElement.className = 'friend-item';
                if (currentChatType === 'friend' && currentChat === friendId) {
                    friendElement.classList.add('active-chat');
                }
                friendElement.textContent = `${friend.name} (${friend.id})`;
                friendElement.addEventListener('click', () => openFriendChat(friendId));
                
                document.getElementById('friendsContainer').appendChild(friendElement);
            });
        }
        
        // Render groups list
        function renderGroupsList() {
            if (!currentUser) return;
            
            document.getElementById('groupsContainer').innerHTML = '';
            
            Object.values(groups).forEach(group => {
                if (group.members.includes(currentUser.id)) {
                    const groupElement = document.createElement('div');
                    groupElement.className = 'group-item';
                    if (currentChatType === 'group' && currentChat === group.id) {
                        groupElement.classList.add('active-chat');
                    }
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = `${group.name} (${group.id})`;
                    
                    groupElement.appendChild(nameSpan);
                    
                    // Add rename button if user is the creator
                    if (group.creator === currentUser.id) {
                        const renameBtn = document.createElement('button');
                        renameBtn.className = 'rename-group-btn';
                        renameBtn.textContent = currentLanguage === "zh" ? "修改名字" : "Rename";
                        renameBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const newName = prompt(currentLanguage === "zh" ? "输入新的群组名称:" : "Enter new group name:", group.name);
                            if (newName && newName.trim() !== '') {
                                group.name = newName.trim();
                                saveGroupData(group);
                                renderGroupsList();
                                if (currentChatType === 'group' && currentChat === group.id) {
                                    document.getElementById('chatTitle').textContent = `${group.name} (${group.id})`;
                                }
                            }
                        });
                        groupElement.appendChild(renameBtn);
                    }
                    
                    groupElement.addEventListener('click', () => openGroupChat(group.id));
                    document.getElementById('groupsContainer').appendChild(groupElement);
                }
            });
        }
        
        // Save group data
        async function saveGroupData(group) {
            // In a real implementation, this would save to the server
            groups[group.id] = group;
            // Save all groups to file (in a real app, we'd have a better way)
            const allGroups = Object.values(groups);
            await saveDataToFile('/groups/all_groups.json', allGroups);
        }
        
        // Open friend chat
        async function openFriendChat(friendId) {
            const friend = findUserById(friendId);
            if (!friend) return;
            
            currentChat = friendId;
            currentChatType = 'friend';
            
            // Update UI
            document.getElementById('chatTitle').textContent = `${friend.name} (${friend.id})`;
            document.getElementById('showMembersBtn').style.display = "none";
            document.getElementById('chatMembers').style.display = "none";
            document.getElementById('inputArea').style.display = "flex";
            
            // Show chat view
            showChatView();
            
            // Load messages
            await loadMessages();
            
            // Update friends list highlight
            renderFriendsList();
        }
        
        // Open group chat
        async function openGroupChat(groupId) {
            const group = groups[groupId];
            if (!group) return;
            
            currentChat = groupId;
            currentChatType = 'group';
            
            // Update UI
            document.getElementById('chatTitle').textContent = `${group.name} (${group.id})`;
            document.getElementById('showMembersBtn').style.display = "block";
            document.getElementById('chatMembers').style.display = "none";
            document.getElementById('inputArea').style.display = "flex";
            
            // Show chat view
            showChatView();
            
            // Load messages
            await loadMessages();
            
            // Update groups list highlight
            renderGroupsList();
        }
        
        // Load messages for current chat
        async function loadMessages() {
            if (!currentChat || !currentChatType) return;
            
            document.getElementById('chatArea').innerHTML = '';
            
            let chatId;
            if (currentChatType === 'friend') {
                chatId = getFriendChatId(currentUser.id, currentChat);
            } else {
                chatId = getGroupChatId(currentChat);
            }
            
            // Load messages from server
            const loadedMessages = await loadDataFromFile(`/messages/${currentUser.id}/${chatId}.json`);
            messages[chatId] = loadedMessages || [];
            
            if (messages[chatId].length === 0) {
                document.getElementById('chatArea').innerHTML = `
                    <div style="text-align: center; color: #7f8c8d; margin-top: 50px;">
                        ${currentLanguage === "zh" ? "还没有消息，开始对话吧！" : "No messages yet. Start the conversation!"}
                    </div>
                `;
                return;
            }
            
            messages[chatId].forEach(msg => {
                const sender = findUserById(msg.sender);
                if (!sender) return;
                
                const isMyMessage = sender.id === currentUser.id;
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isMyMessage ? 'my-message' : 'other-message'}`;
                
                const nameElement = document.createElement('div');
                nameElement.className = 'sender-name';
                nameElement.textContent = sender.name;
                
                const textElement = document.createElement('div');
                textElement.textContent = msg.text;
                
                const timeElement = document.createElement('div');
                timeElement.className = 'message-time';
                timeElement.textContent = formatTime(msg.timestamp);
                
                messageElement.appendChild(nameElement);
                messageElement.appendChild(textElement);
                messageElement.appendChild(timeElement);
                
                document.getElementById('chatArea').appendChild(messageElement);
            });
            
            // Scroll to bottom
            document.getElementById('chatArea').scrollTop = document.getElementById('chatArea').scrollHeight;
        }
        
        // Format time
        function formatTime(date) {
            if (typeof date === 'string') {
                date = new Date(date);
            }
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        // Send message
        async function sendMessage() {
            const text = document.getElementById('messageInput').value.trim();
            if (!text || !currentChat || !currentChatType) return;
            
            let chatId;
            let recipients = [];
            
            if (currentChatType === 'friend') {
                chatId = getFriendChatId(currentUser.id, currentChat);
                recipients = [currentChat];
            } else {
                chatId = getGroupChatId(currentChat);
                const group = groups[currentChat];
                if (group) {
                    recipients = group.members.filter(member => member !== currentUser.id);
                }
            }
            
            if (!messages[chatId]) {
                messages[chatId] = [];
            }
            
            const newMessage = {
                sender: currentUser.id,
                text,
                timestamp: new Date()
            };
            
            messages[chatId].push(newMessage);
            document.getElementById('messageInput').value = '';
            
            // Save message to server
            await saveDataToFile(`/messages/${currentUser.id}/${chatId}.json`, messages[chatId]);
            
            // Update chat UI
            await loadMessages();
        }
        
        // Toggle group members visibility
        function toggleGroupMembers() {
            if (document.getElementById('chatMembers').style.display === "none") {
                showGroupMembers();
            } else {
                document.getElementById('chatMembers').style.display = "none";
            }
        }
        
        // Show group members
        function showGroupMembers() {
            if (!currentChat || currentChatType !== 'group') return;
            
            const group = groups[currentChat];
            if (!group) return;
            
            document.getElementById('chatMembers').innerHTML = '';
            
            group.members.forEach(memberId => {
                const member = findUserById(memberId);
                if (!member) return;
                
                const memberElement = document.createElement('div');
                memberElement.className = 'member-item';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = `${member.name} (${member.id})`;
                
                memberElement.appendChild(nameSpan);
                
                // Add kick button if current user is the creator and it's not themselves
                if (group.creator === currentUser.id && memberId !== currentUser.id) {
                    const kickBtn = document.createElement('span');
                    kickBtn.className = 'kick-member';
                    kickBtn.textContent = currentLanguage === "zh" ? "提出此多人聊天" : "Kick from group";
                    kickBtn.addEventListener('click', () => kickMember(memberId));
                    memberElement.appendChild(kickBtn);
                }
                
                document.getElementById('chatMembers').appendChild(memberElement);
            });
            
            document.getElementById('chatMembers').style.display = "block";
        }
        
        // Kick member from group
        async function kickMember(memberId) {
            if (!currentChat || currentChatType !== 'group') return;
            
            const group = groups[currentChat];
            if (!group || group.creator !== currentUser.id) return;
            
            if (confirm(currentLanguage === "zh" ? "确定要移除此成员吗？" : "Are you sure you want to remove this member from the group?")) {
                group.members = group.members.filter(id => id !== memberId);
                await saveGroupData(group);
                showGroupMembers();
            }
        }
        
        // Send friend request
        async function sendFriendRequest() {
            const friendInput = document.getElementById('friendIdInput').value.trim();
            if (!friendInput) return;
            
            // Find user by ID or username
            let friend = findUserById(friendInput);
            if (!friend) {
                friend = findUserByUsername(friendInput);
            }
            
            if (!friend) {
                alert(currentLanguage === "zh" ? "用户未找到" : "User not found");
                return;
            }
            
            if (friends[currentUser.id].includes(friend.id)) {
                alert(currentLanguage === "zh" ? "该用户已经是您的好友" : "This user is already your friend");
                return;
            }
            
            // Check if request already exists
            const existingRequest = friendRequests[friend.id]?.find(req => 
                req.sender === currentUser.id && req.type === 'friend'
            );
            
            if (existingRequest) {
                alert(currentLanguage === "zh" ? "您已经向该用户发送过请求" : "You already sent a request to this user");
                return;
            }
            
            // Add request
            if (!friendRequests[friend.id]) {
                friendRequests[friend.id] = [];
            }
            
            friendRequests[friend.id].push({
                sender: currentUser.id,
                type: 'friend',
                timestamp: new Date()
            });
            
            // Save to server
            await saveDataToFile(`/friend_requests/${friend.id}.json`, friendRequests[friend.id]);
            
            document.getElementById('friendIdInput').value = '';
            document.getElementById('addFriendBox').style.display = 'none';
            
            alert(currentLanguage === "zh" ? "好友请求已发送！" : "Friend request sent!");
        }
        
        // Send group join request
        async function sendGroupRequest() {
            const groupId = document.getElementById('groupIdInput').value.trim();
            if (!groupId) return;
            
            const group = groups[groupId];
            if (!group) {
                alert(currentLanguage === "zh" ? "群组未找到" : "Group not found");
                return;
            }
            
            if (group.members.includes(currentUser.id)) {
                alert(currentLanguage === "zh" ? "您已经是该群组成员" : "You are already a member of this group");
                return;
            }
            
            // Check if request already exists
            const existingRequest = groupRequests[group.creator]?.find(req => 
                req.sender === currentUser.id && req.groupId === groupId
            );
            
            if (existingRequest) {
                alert(currentLanguage === "zh" ? "您已经发送过加入请求" : "You already sent a request to join this group");
                return;
            }
            
            // Add request
            if (!groupRequests[group.creator]) {
                groupRequests[group.creator] = [];
            }
            
            groupRequests[group.creator].push({
                sender: currentUser.id,
                type: 'group',
                groupId,
                timestamp: new Date()
            });
            
            // Save to server
            await saveDataToFile(`/group_requests/${group.creator}.json`, groupRequests[group.creator]);
            
            document.getElementById('groupIdInput').value = '';
            document.getElementById('addGroupBox').style.display = 'none';
            
            alert(currentLanguage === "zh" ? "群组加入请求已发送！" : "Group join request sent!");
        }
        
        // Create new group
        async function createGroup() {
            const groupName = prompt(currentLanguage === "zh" ? "输入群组名称:" : "Enter group name:");
            if (!groupName || !groupName.trim()) return;
            
            const groupId = generateGroupId();
            const newGroup = {
                id: groupId,
                name: groupName.trim(),
                creator: currentUser.id,
                members: [currentUser.id]
            };
            
            // Save group
            groups[groupId] = newGroup;
            await saveGroupData(newGroup);
            
            // Create messages file
            await saveDataToFile(`/messages/${currentUser.id}/group_${groupId}.json`, []);
            
            // Update UI
            renderGroupsList();
            openGroupChat(groupId);
            
            alert((currentLanguage === "zh" ? "群组创建成功! ID: " : "Group created with ID: ") + groupId);
        }
        
        // Render requests
        function renderRequests() {
            if (!currentUser) return;
            
            document.getElementById('requestsContainer').innerHTML = '';
            
            const userRequests = [
                ...(friendRequests[currentUser.id] || []).map(req => ({ ...req, isFriendRequest: true })),
                ...(groupRequests[currentUser.id] || []).map(req => ({ ...req, isFriendRequest: false }))
            ];
            
            if (userRequests.length === 0) {
                document.getElementById('requestsContainer').innerHTML = `
                    <div style="text-align: center; color: #7f8c8d; margin-top: 50px;">
                        ${currentLanguage === "zh" ? "没有待处理申请" : "No pending requests"}
                    </div>
                `;
                return;
            }
            
            // Sort by timestamp (newest first)
            userRequests.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            userRequests.forEach((req, index) => {
                const sender = findUserById(req.sender);
                if (!sender) return;
                
                const requestElement = document.createElement('div');
                requestElement.className = 'request-item';
                
                let requestText;
                if (req.isFriendRequest) {
                    requestText = `${sender.name} (${sender.id}) ${currentLanguage === "zh" ? "想添加您为好友" : "wants to be your friend"}`;
                } else {
                    const group = groups[req.groupId];
                    if (!group) return;
                    requestText = `${sender.name} (${sender.id}) ${currentLanguage === "zh" ? "想加入您的群组" : "wants to join your group"} "${group.name}" (${group.id})`;
                }
                
                requestElement.textContent = requestText;
                
                const actionsElement = document.createElement('div');
                actionsElement.className = 'request-actions';
                
                const acceptBtn = document.createElement('button');
                acceptBtn.className = 'accept-btn';
                acceptBtn.textContent = currentLanguage === "zh" ? "接受" : "Accept";
                acceptBtn.addEventListener('click', () => handleRequestResponse(index, true, req.isFriendRequest));
                
                const rejectBtn = document.createElement('button');
                rejectBtn.className = 'reject-btn';
                rejectBtn.textContent = currentLanguage === "zh" ? "拒绝" : "Reject";
                rejectBtn.addEventListener('click', () => handleRequestResponse(index, false, req.isFriendRequest));
                
                actionsElement.appendChild(acceptBtn);
                actionsElement.appendChild(rejectBtn);
                requestElement.appendChild(actionsElement);
                
                document.getElementById('requestsContainer').appendChild(requestElement);
            });
        }
        
        // Handle request response
        async function handleRequestResponse(index, accept, isFriendRequest) {
            if (!currentUser) return;
            
            let request;
            if (isFriendRequest) {
                request = friendRequests[currentUser.id][index];
                friendRequests[currentUser.id].splice(index, 1);
                await saveDataToFile(`/friend_requests/${currentUser.id}.json`, friendRequests[currentUser.id]);
            } else {
                request = groupRequests[currentUser.id][index];
                groupRequests[currentUser.id].splice(index, 1);
                await saveDataToFile(`/group_requests/${currentUser.id}.json`, groupRequests[currentUser.id]);
            }
            
            if (accept) {
                if (isFriendRequest) {
                    // Add friend to both users
                    if (!friends[currentUser.id].includes(request.sender)) {
                        friends[currentUser.id].push(request.sender);
                        await saveDataToFile(`/friends/${currentUser.id}.json`, friends[currentUser.id]);
                    }
                    
                    if (!friends[request.sender]) {
                        friends[request.sender] = [];
                    }
                    if (!friends[request.sender].includes(currentUser.id)) {
                        friends[request.sender].push(currentUser.id);
                        await saveDataToFile(`/friends/${request.sender}.json`, friends[request.sender]);
                    }
                    
                    // Initialize chat if it doesn't exist
                    const chatId = getFriendChatId(currentUser.id, request.sender);
                    if (!messages[chatId]) {
                        messages[chatId] = [];
                        await saveDataToFile(`/messages/${currentUser.id}/${chatId}.json`, []);
                    }
                    
                    alert((currentLanguage === "zh" ? "您和" : "You are now friends with ") + 
                          `${findUserById(request.sender)?.name || (currentLanguage === "zh" ? '该用户' : 'this user')}`);
                    renderFriendsList();
                } else {
                    // Add user to group
                    const group = groups[request.groupId];
                    if (group && !group.members.includes(request.sender)) {
                        group.members.push(request.sender);
                        await saveGroupData(group);
                        
                        // Initialize chat if it doesn't exist
                        const chatId = getGroupChatId(group.id);
                        if (!messages[chatId]) {
                            messages[chatId] = [];
                            await saveDataToFile(`/messages/${currentUser.id}/${chatId}.json`, []);
                        }
                        
                        alert(`${findUserById(request.sender)?.name || (currentLanguage === "zh" ? '用户' : 'User')} ` +
                              (currentLanguage === "zh" ? "已加入您的群组" : "has been added to your group") + 
                              ` "${group.name}"`);
                        renderGroupsList();
                    }
                }
            }
            
            renderRequests();
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', async function() {
            // Set up language switcher
            document.getElementById('switchToEnglish').addEventListener('click', () => {
                switchLanguage("en");
            });
            
            document.getElementById('switchToChinese').addEventListener('click', () => {
                switchLanguage("zh");
            });
            
            // Set default language
            switchLanguage(currentLanguage);
            
            // Initialize data
            await initializeData();
            
            // Set up login/register buttons
            document.getElementById('loginBtn').addEventListener('click', async function() {
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value.trim();
                
                if (!username || !password) {
                    alert(currentLanguage === "zh" ? "请输入用户名和密码" : "Please enter both username and password");
                    return;
                }
                
                if (await login(username, password)) {
                    alert(currentLanguage === "zh" ? "登录成功！" : "Login successful!");
                } else {
                    alert(currentLanguage === "zh" ? "用户名或密码错误" : "Invalid username or password");
                }
            });
            
            document.getElementById('registerBtn').addEventListener('click', async function() {
                const name = document.getElementById('registerName').value.trim();
                const username = document.getElementById('registerUsername').value.trim();
                const password = document.getElementById('registerPassword').value.trim();
                const email = document.getElementById('registerEmail').value.trim();
                const code = document.getElementById('registerCode').value.trim();
                
                if (!name || !username || !password || !email || !code) {
                    alert(currentLanguage === "zh" ? "请填写所有字段" : "Please fill in all fields");
                    return;
                }
                
                await register(name, username, password, email, code);
            });
            
            document.getElementById('showRegister').addEventListener('click', showRegisterForm);
            document.getElementById('showLogin').addEventListener('click', showLogin);
            
            // Set up menu buttons
            document.getElementById('friendsChatBtn').addEventListener('click', showFriendsList);
            document.getElementById('groupChatBtn').addEventListener('click', showGroupsList);
            
            document.getElementById('addFriendBtn').addEventListener('click', function() {
                const box = document.getElementById('addFriendBox');
                box.style.display = box.style.display === 'none' ? 'block' : 'none';
                document.getElementById('addGroupBox').style.display = 'none';
            });
            
            document.getElementById('addGroupBtn').addEventListener('click', function() {
                const box = document.getElementById('addGroupBox');
                box.style.display = box.style.display === 'none' ? 'block' : 'none';
                document.getElementById('addFriendBox').style.display = 'none';
            });
            
            document.getElementById('createGroupBtn').addEventListener('click', createGroup);
            document.getElementById('requestsBtn').addEventListener('click', showRequestsView);
            
            document.getElementById('sendFriendRequestBtn').addEventListener('click', sendFriendRequest);
            document.getElementById('sendGroupRequestBtn').addEventListener('click', sendGroupRequest);
            
            document.getElementById('sendButton').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            document.getElementById('uploadButton').addEventListener('click', function() {
                alert(currentLanguage === "zh" ? "文件上传功能将在此实现" : "File upload functionality would be implemented here");
            });
            
            document.getElementById('showMembersBtn').addEventListener('click', toggleGroupMembers);
        });
    </script>
</body>
</html>